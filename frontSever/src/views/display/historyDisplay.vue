<template>
  <div class="content_historyDisplay">
    <div style="--van-nav-bar-icon-color: #f19290">
      <van-nav-bar
        title="æ€»ç»“æŠ¥å‘Šä¸­å¿ƒ"
        left-text=""
        left-arrow
        @click-left="onClickLeft"
      />
    </div>
    <div class="historyDisplay">
      <div style="z-index: 999; transform: translate(1.5vh, 27vh)">
        <van-swipe indicator-color="aquamarine" lazy-render>
          <van-swipe-item
            :autoplay="3000"
            lazy-render
            v-for="image in images"
            :key="image"
            show-indicators="false"
          >
            <div
              style="
                z-index: 99;
                position: flex;
                transform: translate(12.5vh, 0px);
              "
            >
              <img :src="image" style="width: 20vh; height: 50vh" />
            </div>
          </van-swipe-item>
        </van-swipe>
      </div>
      <div style="z-index: 2; transform: translate(2vh, -49vh); width: 60%">
        <div style="font-size: 4.5vh">
          <h14>#{{ today }}</h14>
        </div>
        <div
          style="
            z-index: 2;
            transform: translate(35vw, -5vh);
            font-size: 3vh;
            margin: 0px;
            text-align: right;
            margin-right: 3.5vh;
          "
        >
          <h14>ID:{{ userData.name }}</h14>
        </div>
        <div
          style="z-index: 2; transform: translate(0px, -4vh); font-size: 3.5vh"
        >
          <h14>æ€»ç»“ä»»åŠ¡æŠ¥å‘Š</h14>
        </div>
        <div
          style="z-index: 2; transform: translate(0px, -3vh); font-size: 2.8vh"
        >
          <h14>ğŸ’°ç§¯åˆ†æ€»æ•°ï¼š{{ data.dayCredit }}</h14>
          <div
            style="
              z-index: 2;
              transform: translate(22vh, -7.5vh);
              font-size: 2vh;
              background-color: #fff;
              box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.15);
              border-radius: 20px;
              width: 20vh;
              height: 14vh;
              line-height: 2.5vh; /* ä½¿æ–‡æœ¬åœ¨å®¹å™¨ä¸­å‚ç›´å±…ä¸­ */
              text-align: center; /* æ°´å¹³å±…ä¸­ */
            "
          >
            <div style="z-index: 2; transform: translate(0vw, 3vh)">
              <h14>{{ userData.remindText }}</h14>
            </div>
          </div>
        </div>
        <div
          style="
            z-index: 2;
            transform: translate(1.5vh, -13vh);
            font-size: 2.5vh;
            background-color: #fff;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.15);
            border-radius: 50px;
            width: 15vh;
            height: 10.3vh;
          "
        >
          <div
            style="
              z-index: 2;
              transform: translate(0vw, 1.5vh);
              text-align: center;
              font-size: 2vh;
            "
          >
            <h14>ğŸ†ä»»åŠ¡å®Œæˆæ•°</h14>
          </div>
          <div
            style="
              z-index: 2;
              transform: translate(0vw, 1.5vh);
              text-align: center;
              font-size: 4vh;
            "
          >
            <h14>{{ data.dayCompleteTask }}</h14>
          </div>
        </div>
        <br />
        <div
          style="
            z-index: 2;
            transform: translate(29.5vh, -21vh);
            font-size: 2vh;
            background-color: #fff;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.15);
            border-radius: 30px;
            width: 12.5vh;
            height: 10.3vh;
          "
        >
          <div
            style="
              z-index: 2;
              transform: translate(0vw, 1.5vh);
              text-align: center;
              font-size: 2vh;
            "
          >
            <h14>â­ä»»åŠ¡æ€»æ•°</h14>
          </div>
          <div
            style="
              z-index: 2;
              transform: translate(0vw, 1.5vh);
              text-align: center;
              font-size: 4vh;
            "
          >
            <h14>{{ data.dayAddTask }}</h14>
          </div>
        </div>
        <div
          style="
            z-index: 2;
            transform: translate(0vw, -19vh);
            font-size: 2.5vh;
            background-color: #fff;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.15);
            border-radius: 40px;
            width: 14vh;
            height: 10.3vh;
          "
        >
          <div
            style="
              z-index: 2;
              transform: translate(0vw, 1.5vh);
              text-align: center;
              font-size: 1.75vh;
            "
          >
            <h14>ğŸæ·»åŠ å•†å“æ•°</h14>
          </div>
          <div
            style="
              z-index: 2;
              transform: translate(0vw, 1.5vh);
              text-align: center;
              font-size: 4vh;
              text-align: center; /* æ°´å¹³å±…ä¸­ */
            "
          >
            <h14>{{ data.dayAddProduce }}</h14>
          </div>
        </div>
        <div
          style="
            z-index: 2;
            transform: translate(30vh, -24.5vh);
            font-size: 2.5vh;
            background-color: #fff;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.15);
            border-radius: 50px;
            width: 13.5vh;
            height: 10.3vh;
            align-items: center;
          "
        >
          <div
            style="
              z-index: 2;
              transform: translate(0vw, 1.5vh);
              text-align: center;
              font-size: 1.75vh;
            "
          >
            <h14>ğŸ§¸å…‘æ¢å•†å“æ•°</h14>
          </div>
          <div
            style="
              z-index: 2;
              transform: translate(0vw, 1.5vh);
              text-align: center;
              font-size: 4vh;
            "
          >
            <h14>{{ data.dayReduceRoom }}</h14>
          </div>
        </div>
        <div
          style="
            z-index: 2;
            transform: translate(1vw, -23.5vh);
            font-size: 2.5vh;
            background-color: #fff;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.15);
            border-radius: 30px;
            width: 12.5vh;
            height: 10.3vh;
            align-items: center;
          "
        >
          <div
            style="
              z-index: 2;
              transform: translate(0vw, 0vh);
              text-align: center;
              font-size: 1.75vh;
            "
          >
            <div
              style="
                z-index: 2;
                transform: translate(0vw, 1vh);
                text-align: center;
                font-size: 1.75vh;
              "
            >
              <h14>ğŸŒˆè´­ä¹°å•†å“æ•°</h14>
            </div>
            <div
              style="
                z-index: 2;
                transform: translate(0vw, 1vh);
                text-align: center;
                font-size: 4vh;
              "
            >
              <h14>{{ data.dayBuyProduce }}</h14>
            </div>
          </div>
        </div>
        <div
          style="
            z-index: 2;
            transform: translate(30vh, -26.5vh);
            font-size: 2.5vh;
            background-color: #fff;
            box-shadow: 0px 0px 5px rgba(0, 0, 0, 0.15);
            border-radius: 35px;
            width: 13vh;
            height: 10.3vh;
            align-items: center;
          "
        >
          <div
            style="
              z-index: 2;
              transform: translate(0vw, 0vh);
              text-align: center;
              font-size: 1.75vh;
            "
          ></div>
          <div
            style="
              z-index: 2;
              transform: translate(0vw, 1vh);
              text-align: center;
              font-size: 1.75vh;
            "
          >
            <h14>{{ userData.displayItem }}</h14>
          </div>
          <div
            style="
              z-index: 2;
              transform: translate(0.25vh, 1.5vh);
              text-align: center;
              font-size: 4vh;
            "
          >
            <h14>{{ day }}å¤©</h14>
          </div>
        </div>
      </div>
      <div
        style="
          z-index: 2;
          transform: translate(0vw, -50vh);
          font-size: 2.5vh;
          margin-bottom: 10vh;
        "
      >
        <div style="z-index: 2; transform: translate(2vw, -26vh)">
          <div
            style="
              z-index: 2;
              transform: translate(3.35vh, 0px);
              font-size: 1.5vh;
            "
          >
            <van-image width="12.5vh" height="12.5vh" :src="imageUrl" />
          </div>
          <div
            style="z-index: 2; transform: translate(2vh, 3px); font-size: 1.5vh"
          >
            <h14>æ‰«æäºŒç»´ç ï¼Œå…³æ³¨æ›´å¤šå§ï¼</h14>
          </div>
          <div style="z-index: 2; transform: translate(25vh, -3vh); width: 50%">
            <h14> {{ userData.displayLogo }}</h14>
          </div>
        </div>
      </div>
    </div>
  </div>
  <link
    rel="stylesheet"
    href="https://fonts.googleapis.com/css?family=Ma+Shan+Zheng"
  />
  <van-dialog
    v-model:show="show_1"
    :show-cancel-button="false"
    :show-confirm-button="false"
    width="50vw"
  >
    <br />
    <br />
    <van-loading size="40px" vertical text-size="15px" color="#f19290"
      >ğŸš€æ‹¼å‘½åŠ è½½ä¸­...</van-loading
    >
    <br />
    <br />
  </van-dialog>
</template>

<script>
import jpg1 from "@/assets/display/display01.jpg";
import jpg2 from "@/assets/display/display02.jpg";
import jpg3 from "@/assets/display/display03.jpg";
import jpg4 from "@/assets/display/display04.jpg";
import jwtDecode from "jwt-decode";
import { ref, onMounted } from "vue";
import axios from "axios";
import { useRouter } from "vue-router";

export default {
  setup() {
    const today = ref("");
    const day = ref("");
    const imageUrl = ref("");
    const show_1 = ref(false);
    const data = ref("");
    const userData = ref("");
    const userId = ref("");
    const router = useRouter();
    const x = window.innerWidth;
    const y = window.innerHeight;
    const xy = x / y;

    const images = [jpg1, jpg2, jpg3, jpg4];
    const token = localStorage.getItem("jwtToken"); // ä»localStorageè·å–JWTä»¤ç‰Œ
    if (!token) {
      router.replace("/login");
    }

    const headers = {
      Authorization: `Bearer ${token}`,
    };
    const fetchLoginToken = () => {
      axios
        .post("/api/loginToken?token=" + token)
        .then((response) => {
          if (response.data.code == 0) {
            console.error(response.data.data);
            router.replace("/login");
            return;
          }
          console.log(response.data.data);
          const decodedToken = jwtDecode(token);
          // ä»è§£ç åçš„ä»¤ç‰Œä¸­è·å–ç‰¹å®šçš„æ•°æ®
          userId.value = decodedToken.id; // ä»ä»¤ç‰Œä¸­è·å–ç”¨æˆ·ID
          // å¦‚æœéœ€è¦æ‰§è¡Œä¸€äº›ç‰¹å®šçš„æ“ä½œï¼Œå¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä»£ç 
          fetchDataAndFillForm();
        })
        .catch((error) => {
          console.error("è¯·æ±‚loginTokenæ¥å£å¤±è´¥", error);
          router.replace("/login");
        });
    };

    const fetchDataAndFillForm = async () => {
      try {
        const response = await axios.get(
          `/api/selectUserAllRecord?id=${userId.value}`,
          { headers }
        );
        data.value = response.data.data; // å‡è®¾æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ˜¯ä¸€ä¸ªåŒ…å«ä¸Šè¿°å­—æ®µçš„å¯¹è±¡
        axios
          .get(`/api/selectUser?id=${userId.value}`, {
            headers,
          })
          .then((response) => {
            userData.value = response.data.data; // å‡è®¾æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ˜¯ä¸€ä¸ªåŒ…å«ä¸Šè¿°å­—æ®µçš„å¯¹è±¡
            console.log(userData.value);
            axios
              .get(`/api/generateQRCode?text=${userData.value.displayUrl}`, {
                headers,
              })
              .then((response) => {
                console.log(userData.value.displayUrl);
                imageUrl.value = response.data.data; // å‡è®¾æœåŠ¡å™¨è¿”å›çš„æ•°æ®æ˜¯ä¸€ä¸ªåŒ…å«ä¸Šè¿°å­—æ®µçš„å¯¹è±¡
              });
            const timeDiff = new Date(userData.value.displayDay) - new Date();
            day.value = -Math.floor(timeDiff / (1000 * 60 * 60 * 24));
            const timeDay = new Date();
            today.value =
              timeDay.getFullYear() +
              "-" +
              (timeDay.getMonth() + 1) +
              "-" +
              timeDay.getDate();
          });
      } catch (error) {
        console.error("è·å–æ•°æ®å¤±è´¥", error);
      }
      show_1.value = false;
    };
    // åœ¨ç»„ä»¶åŠ è½½å®Œæˆåè‡ªåŠ¨è§¦å‘æ•°æ®åŠ è½½å’Œå¡«å……
    onMounted(() => {
      fetchLoginToken();
    });
    const onClickLeft = () => router.replace("/User");
    return {
      today,
      day,
      images,
      userId,
      data,
      userData,
      show_1,
      imageUrl,
      onClickLeft,
      xy,
    };
  },
};
</script>

<style scoped>
.content_historyDisplay {
  background-size: cover; /* æ ¹æ®éœ€è¦è°ƒæ•´èƒŒæ™¯å›¾ç‰‡çš„å°ºå¯¸ */
  background-repeat: no-repeat;
  background-position: center;
  width: 100vw;
  height: 100vh;
  zoom: 1;
  /* ç¦æ­¢é¡µé¢å†…å®¹ç¼©æ”¾ */
  /* è®¾ç½®å®¹å™¨é«˜åº¦ï¼Œä½¿å…¶å æ»¡æ•´ä¸ªè§†å£ */
  /* æ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡ */
  /* éšè—æ°´å¹³æ»šåŠ¨æ¡ */
  background-color: aquamarine;
}
.historyDisplay {
  border-radius: 10px;
  margin: 5%;
  zoom: 1;
  /* ç¦æ­¢é¡µé¢å†…å®¹ç¼©æ”¾ */
  width: 90vw;
  height: 88vh;
  /* è®¾ç½®å®¹å™¨é«˜åº¦ï¼Œä½¿å…¶å æ»¡æ•´ä¸ªè§†å£ */
  overflow-y: hidden;
  /* æ˜¾ç¤ºå‚ç›´æ»šåŠ¨æ¡ */
  overflow-x: hidden;
  /* éšè—æ°´å¹³æ»šåŠ¨æ¡ */
  background-color: white;
}
h14 {
  font-family: "Ma Shan Zheng", cursive;
  color: #ec8aa4;
  justify-content: center;
  align-items: center;
}
</style>